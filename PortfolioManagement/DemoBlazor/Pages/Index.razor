@page "/"
@inject HttpClient Http
@inject IDialogService DialogService
@inject IJSRuntime JSRuntime
@using System.Net.Http.Json
@using System.Text.Json
@using Microsoft.JSInterop
<!--@using MudBlazor-->


<MudPaper Class="pa-4">
    <MudText Typo="Typo.h5">Portfolios</MudText>
    <MudDivider Class="my-2" />
    
    <div class="d-flex gap-2 mb-4">
        <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddNewPortfolio">Add new</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Success" OnClick="OpenConfigDialog" Disabled="@(selectedPortfolio == null)">Config</MudButton>
        <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="DeleteSelectedPortfolio" Disabled="@(selectedPortfolio == null)">Delete</MudButton>
    </div>


    <MudTable 
        Items="@portfolios" 
        T="Portfolio" 
        Hover="true"
        Bordered="true"
        Breakpoint="Breakpoint.Sm"
        FixedHeader="true"
        Height="calc(100vh - 250px)"
        @bind-SelectedItem="selectedPortfolio"
        RowStyleFunc="@SelectedRowStyleFunc">
        <HeaderContent>
            <MudTh Style="width: 60px;">№</MudTh>
            <MudTh>Name</MudTh>
            <MudTh>Sol</MudTh>
            <MudTh>wSOL</MudTh>
            <MudTh>USDC</MudTh>
            <MudTh>All</MudTh>
        </HeaderContent>
        <RowTemplate>
            <MudTd DataLabel="№">@context.Number</MudTd>
            <MudTd DataLabel="Name">
                <MudTextField @bind-Value="context.Name" 
                              Margin="Margin.Dense" 
                              Variant="Variant.Text"
                              MaxLength="30"
                              Immediate="false"
                              OnBlur="SavePortfoliosToSession"/>
            </MudTd>
            <MudTd DataLabel="Sol">@context.Sol</MudTd>
            <MudTd DataLabel="wSOL">@context.WSol</MudTd>
            <MudTd DataLabel="USDC">@context.Usdc</MudTd>
            <MudTd DataLabel="All">@context.All</MudTd>
        </RowTemplate>
        <FooterContent>
            <MudTd Style="font-weight: bold;">Total:</MudTd>
            <MudTd></MudTd>
            <MudTd Style="font-weight: bold;">@GetTotalPortfolioSol().ToString("F2")</MudTd>
            <MudTd Style="font-weight: bold;">@GetTotalPortfolioWSol().ToString("F2")</MudTd>
            <MudTd Style="font-weight: bold;">@GetTotalPortfolioUsdc().ToString("F2")</MudTd>
            <MudTd Style="font-weight: bold;">@GetTotalPortfolioAll().ToString("F2")</MudTd>
        </FooterContent>
    </MudTable>
</MudPaper>


@code {
    private List<Portfolio> portfolios = new List<Portfolio>();
    private Portfolio? selectedPortfolio;
    private bool isInitialized = false;


    protected override async Task OnAfterRenderAsync(bool firstRender)
    {
        if (firstRender && !isInitialized)
        {
            await LoadPortfoliosFromSession();
            isInitialized = true;
            StateHasChanged();
        }
    }


    private async Task LoadPortfoliosFromSession()
    {
        try
        {
            var json = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", "portfolios");
            
            if (!string.IsNullOrEmpty(json))
            {
                var loadedPortfolios = JsonSerializer.Deserialize<List<Portfolio>>(json);
                if (loadedPortfolios != null && loadedPortfolios.Count > 0)
                {
                    portfolios = loadedPortfolios;
                    return;
                }
            }
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error loading portfolios: {ex.Message}");
        }


        // Если данных нет или произошла ошибка, создаем начальные данные
        portfolios = new List<Portfolio>
        {
            new Portfolio { Number = 1, Id = Guid.NewGuid() },
            new Portfolio { Number = 2, Id = Guid.NewGuid() },
            new Portfolio { Number = 3, Id = Guid.NewGuid() }
        };
        await SavePortfoliosToSession();
    }


    private async Task SavePortfoliosToSession()
    {
        try
        {
            var json = JsonSerializer.Serialize(portfolios);
            await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", "portfolios", json);
        }
        catch (Exception ex)
        {
            Console.WriteLine($"Error saving portfolios: {ex.Message}");
        }
    }


    private async Task AddNewPortfolio()
    {
        var newPortfolio = new Portfolio 
        { 
            Number = portfolios.Count + 1,
            Id = Guid.NewGuid()
        };
        portfolios.Add(newPortfolio);
        await SavePortfoliosToSession();
    }


    private async Task DeleteSelectedPortfolio()
    {
        if (selectedPortfolio != null)
        {
            // Удаляем также кошельки этого портфеля из sessionStorage
            await JSRuntime.InvokeVoidAsync("sessionStorage.removeItem", $"wallets_{selectedPortfolio.Id}");
            
            portfolios.Remove(selectedPortfolio);
            RenumberPortfolios();
            selectedPortfolio = null;
            await SavePortfoliosToSession();
        }
    }


    private void RenumberPortfolios()
    {
        for (int i = 0; i < portfolios.Count; i++)
        {
            portfolios[i].Number = i + 1;
        }
    }


    private string SelectedRowStyleFunc(Portfolio portfolio, int rowNumber)
    {
        if (selectedPortfolio != null && selectedPortfolio.Equals(portfolio))
        {
            return "background-color: #E3F2FD;";
        }
        return string.Empty;
    }


    private async Task OpenConfigDialog()
    {
        if (selectedPortfolio == null)
            return;


        var parameters = new DialogParameters
        {
            { "PortfolioId", selectedPortfolio.Id }
        };


        var options = new DialogOptions 
        { 
            MaxWidth = MaxWidth.Large,
            FullWidth = true,
            CloseButton = true,
            CloseOnEscapeKey = false,
            DisableBackdropClick = true
        };


        var dialogReference = DialogService.Show<WalletConfigDialog>("", parameters, options);
        var result = await dialogReference.Result;


        // После закрытия диалога получаем данные через componentInstance
        var dialogInstance = (WalletConfigDialog)dialogReference.Dialog;
        var summary = dialogInstance.GetSummary();
        
        // Обновляем портфолио
        selectedPortfolio.Sol = summary.TotalSol.ToString("F2");
        selectedPortfolio.WSol = summary.TotalWSol.ToString("F2");
        selectedPortfolio.Usdc = summary.TotalUsdc.ToString("F2");
        selectedPortfolio.All = summary.TotalAll.ToString("F2");
        
        StateHasChanged();
        await SavePortfoliosToSession();
    }

    // Методы для подсчета итоговых сумм по всем портфелям
    private decimal GetTotalPortfolioSol()
    {
        return portfolios.Sum(p => decimal.TryParse(p.Sol, out var val) ? val : 0);
    }

    private decimal GetTotalPortfolioWSol()
    {
        return portfolios.Sum(p => decimal.TryParse(p.WSol, out var val) ? val : 0);
    }

    private decimal GetTotalPortfolioUsdc()
    {
        return portfolios.Sum(p => decimal.TryParse(p.Usdc, out var val) ? val : 0);
    }

    private decimal GetTotalPortfolioAll()
    {
        return portfolios.Sum(p => decimal.TryParse(p.All, out var val) ? val : 0);
    }


    private class Portfolio
    {
        public Guid Id { get; set; }
        public int Number { get; set; }
        public string Name { get; set; } = string.Empty;
        public string Sol { get; set; } = string.Empty;
        public string WSol { get; set; } = string.Empty;
        public string Usdc { get; set; } = string.Empty;
        public string All { get; set; } = string.Empty;
    }
}
