@using Microsoft.JSInterop
@using MudBlazor
@using System.Linq
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService
@inject SolanaAddressValidator AddressValidator
@inject SolanaBalanceService BalanceService

<MudDialog>
    <TitleContent>
        <MudText Typo="Typo.h6">Completing the portfolio with wallets</MudText>
    </TitleContent>
    <DialogContent>
        <MudPaper Class="pa-4" Style="height: 400px; overflow-y: auto;">
            <MudTable Items="@wallets" Hover="true" Dense="true" Bordered="true" 
                      @bind-SelectedItem="selectedWallet" Style="table-layout: fixed;">
                <HeaderContent>
                    <MudTh Style="width: 60px;">№</MudTh>
                    <MudTh>Address</MudTh>
                    <MudTh Style="width: 80px;">Sol</MudTh>
                    <MudTh Style="width: 80px;">wSOL</MudTh>
                    <MudTh Style="width: 80px;">USDC</MudTh>
                    <MudTh Style="width: 80px;">All</MudTh>
                </HeaderContent>
                <RowTemplate>
                    <MudTd DataLabel="№">@context?.Number</MudTd>
                    <MudTd DataLabel="Address">
                        @if (context != null)
                        {
                            <MudTextField @bind-Value="@context.Address" 
                                          MaxLength="60" 
                                          OnKeyDown="@(async (e) => await OnAddressKeyDown(e, context))"
                                          OnBlur="@(async () => await OnAddressBlur(context))"
                                          Immediate="false" />
                        }
                    </MudTd>
                    <MudTd DataLabel="Sol">@context?.Sol</MudTd>
                    <MudTd DataLabel="wSOL">@context?.WSol</MudTd>
                    <MudTd DataLabel="USDC">@context?.Usdc</MudTd>
                    <MudTd DataLabel="All">@context?.All</MudTd>
                </RowTemplate>
            </MudTable>
        </MudPaper>

        <div class="d-flex gap-2 mt-4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddNewWallet">Add</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="DeleteWallet" Disabled="@(selectedWallet == null)">Delete</MudButton>
        </div>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] 
    MudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public Guid PortfolioId { get; set; }

    private List<Wallet> wallets = new List<Wallet>();
    private Wallet? selectedWallet;
    

    protected override async Task OnInitializedAsync()
    {
        await LoadWalletsFromStorage();
    }

    private async Task OnAddressKeyDown(KeyboardEventArgs e, Wallet wallet)
{
    // При нажатии Enter валидируем адрес
    if (e.Key == "Enter" || e.Key == "Return")
    {
        Console.WriteLine($"Enter pressed for address: {wallet.Address}");
        await ValidateAndSaveAddress(wallet);
    }
}

private async Task OnAddressBlur(Wallet wallet)
{
    // При потере фокуса (blur) также валидируем
    Console.WriteLine($"Blur event for address: {wallet.Address}");
    await ValidateAndSaveAddress(wallet);
}

 private async Task ValidateAndSaveAddress(Wallet wallet)
{
    if (string.IsNullOrWhiteSpace(wallet.Address))
    {
        Console.WriteLine("Address is empty, saving without validation");
        await SaveWalletsToStorage();
        return;
    }

    // Проверка на дубликат
    var isDuplicate = wallets.Any(w => 
        w != wallet && 
        !string.IsNullOrWhiteSpace(w.Address) && 
        w.Address.Equals(wallet.Address, StringComparison.OrdinalIgnoreCase));
    
    if (isDuplicate)
    {
        Console.WriteLine($"Duplicate address detected: {wallet.Address}");
        await ShowDuplicateAddressModal();
        wallet.Address = string.Empty;
        StateHasChanged();
        return;
    }

    Console.WriteLine($"Starting validation for address: {wallet.Address}");
    
    bool isValid = await AddressValidator.ValidateAddressAsync(wallet.Address);
    
    Console.WriteLine($"Validation result: {isValid}");
    
    if (isValid)
    {
        Console.WriteLine("Address is valid, fetching balances...");
        
        var balances = await BalanceService.GetBalancesAsync(wallet.Address);
        
        wallet.Sol = balances.Sol.ToString("G");
        wallet.WSol = balances.WSol.ToString("G");
        wallet.Usdc = balances.Usdc.ToString("G");
        wallet.All = balances.TotalUsd.ToString("F2");
        
        await SaveWalletsToStorage();
        StateHasChanged();
    }
    else
    {
        Console.WriteLine("Address is invalid, showing modal...");
        await ShowInvalidAddressModal();
        wallet.Address = string.Empty;
        StateHasChanged();
    }
}

private async Task ShowDuplicateAddressModal()
{
    await ShowMessageModal("Duplicate Wallet", "This wallet is already here");
}

private async Task ShowMessageModal(string title, string message)
{
    var parameters = new DialogParameters
    {
        ["ContentText"] = message,
        ["ButtonText"] = "OK",
        ["Color"] = Color.Error
    };
    
    var options = new DialogOptions 
    { 
        CloseButton = false,
        MaxWidth = MaxWidth.Small
    };

    var dialog = DialogService.Show<MudMessageBox>(title, parameters, options);
    await dialog.Result;
}


    private async Task ShowInvalidAddressModal()
    {
        var parameters = new DialogParameters
        {
            { "Message", "Invalid Solana address" }
        };

        var options = new DialogOptions
        {
            NoHeader = true,
            CloseOnEscapeKey = false,
            CloseButton = false
        };

        var dialog = DialogService.Show<InvalidAddressDialog>("", parameters, options);
        
        // Закрываем через 2 секунды
        await Task.Delay(2000);
        dialog.Close();
    }

    private async Task AddNewWallet()
    {
        var newWallet = new Wallet { Number = wallets.Count + 1 };
        wallets.Add(newWallet);
        await SaveWalletsToStorage();
    }

    private async Task DeleteWallet()
    {
        if (selectedWallet != null)
        {
            wallets.Remove(selectedWallet);
            RenumberWallets();
            selectedWallet = null;
            await SaveWalletsToStorage();
        }
    }

    private void RenumberWallets()
    {
        for (int i = 0; i < wallets.Count; i++)
        {
            wallets[i].Number = i + 1;
        }
    }

    private async Task LoadWalletsFromStorage()
    {
        var key = $"wallets_{PortfolioId}";
        var json = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", key);
        
        if (!string.IsNullOrEmpty(json))
        {
            wallets = System.Text.Json.JsonSerializer.Deserialize<List<Wallet>>(json) ?? new List<Wallet>();
        }
        else
        {
            wallets = new List<Wallet>
            {
                new Wallet { Number = 1 },
                new Wallet { Number = 2 },
                new Wallet { Number = 3 }
            };
        }
    }

    private async Task SaveWalletsToStorage()
    {
        var key = $"wallets_{PortfolioId}";
        var json = System.Text.Json.JsonSerializer.Serialize(wallets);
        await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", key, json);
    }

    
    public class Wallet
    {
        public int Number { get; set; }
        public string Address { get; set; } = string.Empty;
        public string Sol { get; set; } = string.Empty;
        public string WSol { get; set; } = string.Empty;
        public string Usdc { get; set; } = string.Empty;
        public string All { get; set; } = string.Empty;
    }
}