@using Microsoft.JSInterop
@using MudBlazor
@inject IJSRuntime JSRuntime
@inject IDialogService DialogService

<MudDialog>
    <DialogContent>
        <MudPaper Class="pa-4" Style="height: 400px; overflow-y: auto;">
            <MudTable Items="@wallets" Hover="true" Dense="true" Bordered="true" 
                      @bind-SelectedItem="selectedWallet" Style="table-layout: fixed;">
                <HeaderContent>
                    <MudTh Style="width: 60px;">№</MudTh>
                    <MudTh>Address</MudTh>
                    <MudTh Style="width: 80px;">Sol</MudTh>
                    <MudTh Style="width: 80px;">wSOL</MudTh>
                    <MudTh Style="width: 80px;">USDC</MudTh>
                    <MudTh Style="width: 80px;">All</MudTh>
                </HeaderContent>
                <RowTemplate>
    <MudTd DataLabel="№">@context?.Number</MudTd>
    <MudTd DataLabel="Address">
        @if (context != null)
        {
            <MudTextField @bind-Value="@context.Sol" 
                          MaxLength="60" 
                          OnBlur="@(() => OnAddressBlur(context))"
                          Immediate="false" />
        }
    </MudTd>
    <MudTd DataLabel="Sol">@context?.Sol</MudTd>
    <MudTd DataLabel="wSOL">@context?.WSol</MudTd>
    <MudTd DataLabel="USDC">@context?.Usdc</MudTd>
    <MudTd DataLabel="All">@context?.All</MudTd>
</RowTemplate>

            </MudTable>
        </MudPaper>

        <div class="d-flex gap-2 mt-4">
            <MudButton Variant="Variant.Filled" Color="Color.Primary" OnClick="AddNewWallet">Add</MudButton>
            <MudButton Variant="Variant.Filled" Color="Color.Error" OnClick="DeleteWallet" Disabled="@(selectedWallet == null)">Delete</MudButton>
        </div>
    </DialogContent>
</MudDialog>

@code {
    [CascadingParameter] 
    MudDialogInstance? MudDialog { get; set; }

    [Parameter]
    public string PortfolioId { get; set; } = string.Empty;

    private List<Wallet> wallets = new List<Wallet>();
    private Wallet? selectedWallet;
    private string tempAddress = string.Empty;

    protected override async Task OnInitializedAsync()
    {
        await LoadWalletsFromStorage();
    }

    private async Task OnAddressBlur(Wallet wallet)
    {
        if (string.IsNullOrWhiteSpace(wallet.Sol))
        {
            await SaveWalletsToStorage();
            return;
        }

        bool isValid = await ValidateSolanaAddress(wallet.Sol);
        if (isValid)
        {
            await SaveWalletsToStorage();
        }
        else
        {
            wallet.Sol = string.Empty; // Очищаем невалидный адрес
        }
    }

    private async Task<bool> ValidateSolanaAddress(string address)
    {
        try
        {
            using var httpClient = new HttpClient();
            var url = $"https://b2b.api.arbitragescanner.io/api/onchain/v1/solana/address/general_info?address={address}";
            
            var request = new HttpRequestMessage(HttpMethod.Get, url);
            request.Headers.Add("accept", "application/json");
            request.Headers.Add("X-API-Key", "JYnC6aZete6f6edaksMh5x");

            var response = await httpClient.SendAsync(request);
            var body = await response.Content.ReadAsStringAsync();

            if (!response.IsSuccessStatusCode || body.Contains("\"error\""))
            {
                await ShowInvalidAddressModal();
                return false;
            }

            return true;
        }
        catch
        {
            await ShowInvalidAddressModal();
            return false;
        }
    }

    private async Task ShowInvalidAddressModal()
    {
        var parameters = new DialogParameters
        {
            { "Message", "Invalid Solana address" }
        };

        var options = new DialogOptions
        {
            NoHeader = true,
            CloseOnEscapeKey = false,
            CloseButton = false
        };

        var dialog = DialogService.Show<InvalidAddressDialog>("", parameters, options);
        await Task.Delay(2000);
        dialog.Close();
    }

    private void AddNewWallet()
    {
        var newWallet = new Wallet { Number = wallets.Count + 1 };
        wallets.Add(newWallet);
        SaveWalletsToStorage().Wait();
    }

    private void DeleteWallet()
    {
        if (selectedWallet != null)
        {
            wallets.Remove(selectedWallet);
            RenumberWallets();
            selectedWallet = null;
            SaveWalletsToStorage().Wait();
        }
    }

    private void RenumberWallets()
    {
        for (int i = 0; i < wallets.Count; i++)
        {
            wallets[i].Number = i + 1;
        }
    }

    private async Task LoadWalletsFromStorage()
    {
        var key = $"wallets_{PortfolioId}";
        var json = await JSRuntime.InvokeAsync<string>("sessionStorage.getItem", key);
        
        if (!string.IsNullOrEmpty(json))
        {
            wallets = System.Text.Json.JsonSerializer.Deserialize<List<Wallet>>(json) ?? new List<Wallet>();
        }
        else
        {
            wallets = new List<Wallet>
            {
                new Wallet { Number = 1 },
                new Wallet { Number = 2 },
                new Wallet { Number = 3 }
            };
        }
    }

    private async Task SaveWalletsToStorage()
    {
        var key = $"wallets_{PortfolioId}";
        var json = System.Text.Json.JsonSerializer.Serialize(wallets);
        await JSRuntime.InvokeVoidAsync("sessionStorage.setItem", key, json);
    }

    public class Wallet
    {
        public int Number { get; set; }
        public string Sol { get; set; } = string.Empty;
        public string WSol { get; set; } = string.Empty;
        public string Usdc { get; set; } = string.Empty;
        public string All { get; set; } = string.Empty;
    }
}
